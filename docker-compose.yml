services:
  # ============================================================================
  # PRIVATE ADMIN PANEL (Accessible only via SSH Tunnel)
  # ============================================================================
  admin-nginx:
    image: nginx:alpine
    container_name: asir_admin_nginx
    restart: always
    ports:
      - "127.0.0.1:8888:80" # Only binds to localhost:8888
    volumes:
      - ./nginx/conf.d/admin.conf:/etc/nginx/conf.d/default.conf:ro
      - ./src:/var/www/html:ro
    networks:
      - frontend_net
    depends_on:
      - php-app

  # ============================================================================
  # APPLICATION BACKEND (PHP-FPM)
  # ============================================================================
  php-app:
    build: ./php
    container_name: asir_php
    restart: always
    user: "1000:1000" # Run as non-root user
    volumes:
      - ./src:/var/www/html:ro
      - ./php/conf.d/custom.ini:/usr/local/etc/php/conf.d/custom.ini:ro
      - ./geoip/GeoLite2-City.mmdb:/usr/share/GeoIP/GeoLite2-City.mmdb:ro
    environment:
      - MYSQL_HOST=mysql
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - LOKI_URL=http://loki:3100
      - GEOIP_MMDB_PATH=/usr/share/GeoIP/GeoLite2-City.mmdb
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=64m
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    pids_limit: 128
    mem_limit: "512m"
    networks:
      - frontend_net
      - backend_net
    depends_on:
      mysql:
        condition: service_healthy

  # ============================================================================
  # DATABASE (Isolated)
  # ============================================================================
  mysql:
    image: mysql:8.0
    container_name: asir_mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    healthcheck:
      # Use CMD-SHELL so the password env var expands inside the container, and wait longer on cold starts
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -p$$MYSQL_ROOT_PASSWORD || exit 1"]
      interval: 10s
      timeout: 5s
      start_period: 60s
      retries: 12
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql/init:/docker-entrypoint-initdb.d:ro
    networks:
      - backend_net
    # No ports exposed to host!

  # ============================================================================
  # OBSERVABILITY STACK (Loki + Promtail)
  # ============================================================================
  loki:
    image: grafana/loki:2.9.2
    container_name: asir_loki
    restart: always
    volumes:
      - ./loki/config.yml:/etc/loki/local-config.yaml:ro
      - loki_data:/loki
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:3100/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - backend_net

  promtail:
    image: grafana/promtail:2.9.2
    container_name: asir_promtail
    restart: always
    volumes:
      - ./promtail/config.yml:/etc/promtail/config.yml:ro
      - /var/log:/var/log/host:ro # Read host logs (Fail2ban, Auth)
      - ./promtail/positions:/positions
    command: -config.file=/etc/promtail/config.yml
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:9080/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    depends_on:
      loki:
        condition: service_healthy
    networks:
      - backend_net


networks:
  frontend_net:
    # External access required for WAF
    driver: bridge
  backend_net:
    # Internal set to false to allow Grafana port binding to host
    # Security is maintained by not exposing ports for MySQL/Loki
    internal: true

volumes:
  mysql_data:
  loki_data:
