log_format waf_json escape=json '{'
    '"ts":"$time_iso8601",'
    '"remote_addr":"$remote_addr",'
    '"status":$status,'
    '"request":"$request",'
    '"uri":"$uri",'
    '"args":"$args",'
    '"method":"$request_method",'
    '"host":"$host",'
    '"protocol":"$server_protocol",'
    '"referrer":"$http_referer",'
    '"user_agent":"$http_user_agent"'
'}';

server {
    listen 80;
    server_name localhost;
    
    # Security Headers
    server_tokens off;
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";
    add_header X-XSS-Protection "1; mode=block";

    access_log /var/log/nginx/access.log waf_json;

    location / {
        root /usr/share/nginx/html;
        index index.html;
        # Return 403 for suspicious activities (handled by ModSec)
        # or just serve the static page
    }

    # Deny access to hidden files
    location ~ /\. {
        deny all;
    }
    
    # Custom error page for 403 (Blocked by WAF)
    error_page 403 /403.html;
    location = /403.html {
        root /usr/share/nginx/html;
        internal;
    }
}
